{% extends "base.html" %}
{% block title %}Calling on His Name â€” Study Guide{% endblock %}
{% block content %}

<!-- Scoped page styles (CSP nonce) -->
<style nonce="{{ csp_nonce() }}">
  /* Dark theme is opt-in via .study-dark on #studyRoot */
  #studyRoot.study-dark{
    --bg:#0f1420; --fg:#e9eef5; --muted:#b7c2d0; --accent:#7cd1ff;
    --card:#151c2b; --highlight:#0ea5e9; --soft:#0c2838;
    color: var(--fg);
    background: var(--bg);
  }
  #studyRoot.study-dark a{ color: var(--accent); text-decoration: none; }
  #studyRoot.study-dark a:focus, #studyRoot.study-dark a:hover{ text-decoration: underline; }

  .study-wrap{ max-width: 900px; margin: 0 auto; padding: 1.2rem; }
  .study-header{ position:sticky; top:0; z-index:10; backdrop-filter: blur(6px); border-bottom:1px solid #223; }
  /* Header background adapts: darker in dark mode, light in light mode */
  #studyRoot:not(.study-dark) .study-header{ background: rgba(255,255,255,.9); }
  #studyRoot.study-dark .study-header{ background: rgba(15,20,32,0.9); }

  .study-title{ font-size: clamp(1.6rem, 3vw, 2.2rem); margin: .25rem 0 .5rem; }
  .subtitle{ color: var(--muted); margin-bottom: .5rem; }
  nav.toc{ display:flex; flex-wrap:wrap; gap:.5rem; margin:.5rem 0 .75rem; }
  nav.toc a{ padding:.45rem .65rem; border:1px solid #2a354a; border-radius:.6rem; background: #0d1422; font-size:.95rem; white-space:nowrap; }
  #studyRoot:not(.study-dark) nav.toc a{ background:#f5f7fb; border-color:#dfe6ef; }

  .study-main{ padding: 1rem 0 2rem; }
  .section{ border-radius: 1rem; padding: 1rem; margin: 1rem 0; scroll-margin-top: 5.5rem; }
  /* Card surfaces for each theme */
  #studyRoot.study-dark .section{ background: var(--card); border:1px solid #273347; }
  #studyRoot:not(.study-dark) .section{ background:#fff; border:1px solid var(--border, #e6e9ef); }

  .section h2{ font-size: clamp(1.25rem, 2.6vw, 1.6rem); margin-top: 0; }

  .scripture{ border-left:4px solid var(--highlight, #0ea5e9); padding:.75rem .9rem; border-radius:.5rem; margin:.5rem 0 1rem; }
  #studyRoot.study-dark .scripture{ background:#0d1422; color:var(--muted); }
  #studyRoot:not(.study-dark) .scripture{ background:#f6f8fb; color:#334155; }

  .lesson{ border-radius:.75rem; padding:.75rem .9rem; margin-top:.8rem; }
  #studyRoot.study-dark .lesson{ background:var(--soft); border:1px dashed #2b7aa4; }
  #studyRoot:not(.study-dark) .lesson{ background:#f0f9ff; border:1px dashed #7ac3e8; }

  .pray{ border-radius:.65rem; padding:.6rem .8rem; margin-top:.7rem; font-style:italic; }
  #studyRoot.study-dark .pray{ background:#0b2030; border:1px solid #264a66; }
  #studyRoot:not(.study-dark) .pray{ background:#f9fbff; border:1px solid #bcd7ee; }

  .flow{ display:flex; justify-content:space-between; gap:.75rem; margin-top:1rem; flex-wrap:wrap; }
  .flow a{ padding:.5rem .8rem; border-radius:.6rem; border:1px solid #2a354a; background:#0d1422; text-decoration:none; }
  #studyRoot:not(.study-dark) .flow a{ background:#fff; border-color:#e6e9ef; }

  .card-lite{ border-radius:1rem; padding:1rem; margin-top:1rem; }
  #studyRoot.study-dark .card-lite{ background:#0c1a29; border:1px solid #273347; }
  #studyRoot:not(.study-dark) .card-lite{ background:#fff; border:1px solid #e6e9ef; }

  .cols{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:.8rem; }
  .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }

  /* Theme switch button (small, unobtrusive) */
  .theme-switch { margin-left:auto; }
  .theme-switch .btn { padding:.35rem .6rem; border-radius:.5rem; }

  /* Print */
  @media print{
    .study-header{ position:static; background:transparent; border:none; }
    #studyRoot{ color:#000; }
    .section{ break-inside:avoid; background:#fff !important; border-color:#ddd !important; }
    nav.toc a{ border-color:#ccc !important; background:#fff !important; }
    .scripture{ background:#f6f8fb !important; border-color:#0ea5e9 !important; color:#222 !important; }
    .lesson{ background:#f2fafc !important; border-color:#7ac3e8 !important; color:#000 !important; }
    .pray{ background:#f9fbff !important; border-color:#bcd7ee !important; color:#000 !important; }
    a{ color:#0645ad !important; }
  }
</style>

<div id="studyRoot">
  <!-- Sticky sub-header within page body -->
  <div class="study-header">
    <div class="study-wrap" style="display:flex; align-items:center; gap:.75rem;">
      <div>
        <h1 class="study-title">Calling on His Name</h1>
        <p class="subtitle">Simple study guide â€” short, clear, and prayer-focused.</p>
      </div>
      <div class="theme-switch">
        <button type="button" class="btn soft small" id="themeToggle" aria-pressed="false" aria-label="Toggle theme">ğŸŒ“ Theme</button>
      </div>
    </div>
    <div class="study-wrap">
      <nav class="toc" aria-label="Lesson links">
        <a href="#1-god-created-man-with-a-spirit">1. God Created Man With a Spirit</a>
        <a href="#2-regenerated-in-our-spirit">2. Regenerated in Our Spirit</a>
        <a href="#3-one-spirit-with-the-lord">3. One Spirit With the Lord</a>
        <a href="#4-begin-the-day-by-praying">4. Begin the Day by Praying</a>
        <a href="#5-why-we-pray">5. Why We Pray</a>
        <a href="#6-how-we-pray">6. How We Pray & Drink the Spirit</a>
      </nav>
    </div>
  </div>

  <main class="study-main">
    <div class="study-wrap">

      <!-- Sections unchanged from your content -->
      <section id="1-god-created-man-with-a-spirit" class="section" aria-labelledby="h2-1">
        <h2 id="h2-1">1. God Created Man With a Spirit</h2>
        <div class="scripture">
          <strong>ğŸ“– Scripture Reading:</strong><br/>
          Genesis 1:27 â€” â€œGod created man in His own image.â€<br/>
          Job 32:8 â€” â€œThere is a spirit in man.â€
        </div>
        <p>God made you special â€” in His image. You were made to match Christ.</p>
        <p>God made you like a vessel (a cup). A cup holds water. You were made to hold God.</p>
        <p>God gave you a spirit â€” the deep â€œinside you.â€ Like a lamp inside, it can shine with Godâ€™s light.</p>
        <p>Think of a phone. It looks nice, but without power it cannot work. Your spirit is where Godâ€™s power comes in.</p>
        <div class="lesson"><strong>âœ¨ Lesson:</strong> You are not empty. You are a vessel made to receive Godâ€™s Spirit.</div>
        <div class="pray">ğŸ™ Prayer: â€œLord Jesus, fill my heart with Your Spirit today.â€</div>
        <div class="flow">
          <a href="#top" aria-label="Back to top">â¬† Back to top</a>
          <a href="#2-regenerated-in-our-spirit" aria-label="Next lesson">Next âœ</a>
        </div>
      </section>

      <section id="2-regenerated-in-our-spirit" class="section" aria-labelledby="h2-2">
        <h2 id="h2-2">2. Regenerated in Our Spirit</h2>
        <div class="scripture">
          <strong>ğŸ“– Scripture Reading:</strong><br/>
          John 3:6 â€” â€œThat which is born of the Spirit is spirit.â€<br/>
          John 4:24 â€” â€œGod is Spirit, and those who worship Him must worship in spirit.â€<br/>
          Romans 8:16 â€” â€œThe Spirit Himself witnesses with our spirit that we are children of God.â€
        </div>
        <p>When we say â€œyesâ€ to Jesus, Godâ€™s Spirit makes our spirit alive. This is â€œborn again.â€</p>
        <p>Itâ€™s like turning on a light in a dark room. Inside feels new and warm.</p>
        <p>Our spirit is made to worship God â€” like a stomach made to eat. Jesus is our living bread.</p>
        <p>Godâ€™s Spirit and our spirit agree. Inside, we feel, â€œGod is my Father.â€</p>
        <div class="lesson"><strong>âœ¨ Lesson:</strong> You are born again in your spirit â€” to worship and enjoy God.</div>
        <div class="pray">ğŸ™ Prayer: â€œLord, turn on Your light inside me every day.â€</div>
        <div class="flow">
          <a href="#1-god-created-man-with-a-spirit" aria-label="Previous lesson">â—€ Prev</a>
          <a href="#3-one-spirit-with-the-lord" aria-label="Next lesson">Next âœ</a>
        </div>
      </section>

      <section id="3-one-spirit-with-the-lord" class="section" aria-labelledby="h2-3">
        <h2 id="h2-3">3. One Spirit With the Lord</h2>
        <div class="scripture">
          <strong>ğŸ“– Scripture Reading:</strong><br/>
          1 Corinthians 15:45 â€” â€œThe last Adam became a life-giving Spirit.â€<br/>
          1 Corinthians 6:17 â€” â€œHe who is joined to the Lord is one spirit.â€
        </div>
        <p>Jesus died and rose. He is the life-giving Spirit. His Spirit joins with our spirit.</p>
        <p>Like Bluetooth connects phone and speaker, our spirit connects to Jesus. If we do wrong, the connection feels weak.</p>
        <p>We say, â€œLord, Iâ€™m sorry.â€ The connection is clear again. His life flows in us.</p>
        <p>This is the best way to live â€” one spirit with the Lord, every day.</p>
        <div class="lesson"><strong>âœ¨ Lesson:</strong> You are joined to the Lord. His Spirit and your spirit are one.</div>
        <div class="pray">ğŸ™ Prayer: â€œJesus, keep me connected with You always.â€</div>
        <div class="flow">
          <a href="#2-regenerated-in-our-spirit" aria-label="Previous lesson">â—€ Prev</a>
          <a href="#4-begin-the-day-by-praying" aria-label="Next lesson">Next âœ</a>
        </div>
      </section>

      <section id="4-begin-the-day-by-praying" class="section" aria-labelledby="h2-4">
        <h2 id="h2-4">4. Begin the Day by Praying</h2>
        <div class="scripture">
          <strong>ğŸ“– Scripture Reading:</strong><br/>
          Isaiah 12:4 â€” â€œGive thanks to Jehovah; call upon His name!â€<br/>
          Romans 10:12 â€” â€œThe Lord is rich to all who call upon Him.â€
        </div>
        <p><strong>Calling = Praying.</strong> To call on Jesus means to pray â€” speaking His name out loud or in your heart.</p>
        <p>Morning prayer is like opening a window for fresh air. Say, â€œO Lord Jesus,â€ and let His peace come in.</p>
        <p>Even a whisper is prayer. God hears every voice â€” loud or soft.</p>
        <div class="lesson"><strong>âœ¨ Lesson:</strong> Start your day by praying, â€œLord Jesus, be with me today.â€ He brings light, peace, and strength.</div>
        <div class="pray">ğŸ™ Prayer: â€œLord Jesus, I give You this day. Stay close to me.â€</div>
        <div class="flow">
          <a href="#3-one-spirit-with-the-lord" aria-label="Previous lesson">â—€ Prev</a>
          <a href="#5-why-we-pray" aria-label="Next lesson">Next âœ</a>
        </div>
      </section>

      <section id="5-why-we-pray" class="section" aria-labelledby="h2-5">
        <h2 id="h2-5">5. Why We Pray</h2>
        <div class="scripture">
          <strong>ğŸ“– Scripture Reading:</strong><br/>
          Romans 10:13 â€” â€œWhoever calls upon the name of the Lord shall be saved.â€<br/>
          Psalm 116:13 â€” â€œI will take up the cup of salvation and call upon the name of Jehovah.â€
        </div>
        <p>Why pray?</p>
        <ul>
          <li>To be saved â€” to belong to Jesus (Rom. 10:13).</li>
          <li>To be rescued when life hurts (Psalms).</li>
          <li>To receive the Spiritâ€™s help (Acts 2:21).</li>
          <li>To â€œeat and drinkâ€ Jesus as living water (Isa. 55:1,6).</li>
          <li>To enjoy His rich love (Rom. 10:12).</li>
          <li>To wake up our spirit when we feel low (Isa. 64:7).</li>
          <li>To calm anger, fear, or worry; to say â€œthank Youâ€ for food, safety, family.</li>
        </ul>
        <div class="lesson"><strong>âœ¨ Lesson:</strong> Prayer saves, strengthens, feeds, and gives joy. When you pray, you are never alone.</div>
        <div class="pray">ğŸ™ Prayer: â€œFather, hear me when I call. Thank You for being near.â€</div>
        <div class="flow">
          <a href="#4-begin-the-day-by-praying" aria-label="Previous lesson">â—€ Prev</a>
          <a href="#6-how-we-pray" aria-label="Next lesson">Next âœ</a>
        </div>
      </section>

      <section id="6-how-we-pray" class="section" aria-labelledby="h2-6">
        <h2 id="h2-6">6. How We Pray &amp; Drink the Spirit</h2>
        <div class="scripture">
          <strong>ğŸ“– Scripture Reading:</strong><br/>
          1 Corinthians 12:13 â€” â€œIn one Spirit we were all baptized into one Body, and were all given to drink one Spirit.â€<br/>
          1 Corinthians 12:3 â€” â€œNo one can say, â€˜Jesus is Lord!â€™ except in the Holy Spirit.â€
        </div>
        <p>We pray with:</p>
        <ul>
          <li>A clean heart (2 Tim. 2:22).</li>
          <li>Clean lips (Zeph. 3:9).</li>
          <li>Every day, all our days (Psa. 88:9; 116:2).</li>
          <li>Together with others â€” we belong to one Body.</li>
        </ul>
        <p><strong>How do we â€œdrink the Spiritâ€?</strong> It means letting Godâ€™s love and life come inside â€” like cool water when you are thirsty.</p>
        <p><strong>Breathing prayer:</strong> Breathe in, say â€œLord.â€ Breathe out, say â€œJesus.â€ Slowly. This is praying and drinking at the same time.</p>
        <p>God hears our breath-prayers: â€œDo not hide Your ear at my breathing, at my cryâ€ (Lam. 3:56).</p>
        <div class="lesson"><strong>âœ¨ Lesson:</strong> Prayer is our breathing. Keep drinking the Spirit â€” alone and with others.</div>
        <div class="pray">ğŸ™ Prayer: â€œLord Jesus, I breathe You in. Fill me with Your Spirit.â€</div>
        <div class="flow">
          <a href="#5-why-we-pray" aria-label="Previous lesson">â—€ Prev</a>
          <a href="#top" aria-label="Back to top">â¬† Back to top</a>
        </div>
      </section>

      <section class="card-lite section" aria-labelledby="h2-end">
        <h2 id="h2-end">Reflection Card</h2>
        <div class="cols">
          <div>ğŸ™ <strong>PRAY</strong> = Talk to God (out loud or silent)</div>
          <div>ğŸ’¨ <strong>SPIRIT</strong> = Godâ€™s breath in you</div>
          <div>ğŸ•¯ï¸ <strong>YOU</strong> = Godâ€™s light can shine</div>
          <div>â¤ï¸ <strong>CALL HIS NAME</strong> = Feel His love</div>
        </div>
        <div class="pray">â€œLord Jesus, teach me to talk with You, listen to You, and live close to You each day.â€</div>
      </section>

      <p id="top" class="sr-only">Top of page</p>

      <div class="flow" style="margin-top:1rem">
        <a class="btn soft" href="{{ url_for('study_hub') }}">ğŸ“š Back to Study Hub</a>
        <a class="btn soft" href="{{ url_for('home') }}">ğŸ  Home</a>
      </div>
    </div>
  </main>
</div>

<!-- Theme bootstrapping (CSP nonce) -->
<script nonce="{{ csp_nonce() }}">
  (function(){
    const root = document.getElementById('studyRoot');
    if (!root) return;

    // 1) URL override ?theme=dark|light
    const params = new URLSearchParams(location.search);
    const forced = params.get('theme');
    const isNightHour = (h) => (h >= 18 || h < 6);
    const now = new Date();
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

    let enableDark;
    if (forced === 'dark') enableDark = true;
    else if (forced === 'light') enableDark = false;
    else enableDark = prefersDark || isNightHour(now.getHours());

    root.classList.toggle('study-dark', !!enableDark);

    // 2) Manual toggle (persists for the session)
    const btn = document.getElementById('themeToggle');
    if (btn){
      btn.addEventListener('click', () => {
        const on = root.classList.toggle('study-dark');
        btn.setAttribute('aria-pressed', on ? 'true' : 'false');
      });
    }
  })();
</script>

{% endblock %}
