{% extends "base.html" %}
{% block title %}Admin â€” SoulStart{% endblock %}
{% block content %}

<section class="hero hero-day" style="background-image:url('{{ url_for('static', filename='img/hero_day.jpg') }}')">
  <div class="hero-inner" style="padding:24px 22px;">
    <h1>âš™ï¸ Admin Dashboard</h1>
    <p class="muted">Manage outreach, requests, and WhatsApp delivery.</p>
  </div>
</section>

<div class="card admin-card">
  <h3>Send WhatsApp</h3>

 <form id="waForm" method="post" action="{{ url_for('admin_whatsapp_send') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="row">
      <label>Date</label>
      <input type="date" name="date" value="{{ today_str }}">
      <label>Mode</label>
      <select name="mode">
        <option value="both">Both (Morning &amp; Night)</option>
        <option value="morning">Morning only</option>
        <option value="night">Night only</option>
        <option value="verses">Verses</option>
      </select>
    </div>

    <div class="row">
      <label>Chat (optional)</label>
      <input type="text" name="chat" placeholder="Silent SoulConnect">
      <label>Paste delay (s)</label>
      <input type="number" name="paste_delay" value="8" min="0" step="1" style="width:6rem">
    </div>

    <div class="row">
      <label><input type="checkbox" name="send"> Auto-send</label>
      <label><input type="checkbox" name="open_only"> Open only</label>
      <label><input type="checkbox" name="dry_run"> Dry run (print only)</label>
    </div>

    <button class="btn" type="submit" id="waSubmit">Send</button>
  </form>

  <pre id="status" class="status hidden" aria-live="polite"></pre>
</div>

<div class="card admin-card">
  <h3>People & Reports</h3>
  <p>
    <a class="btn soft" href="{{ url_for('admin_verses') }}">ğŸ“– Theme Verses</a>
    <a class="btn soft" href="{{ url_for('admin_requests') }}">ğŸ“¥ Prayer Requests</a>
    <a class="btn soft" href="{{ url_for('admin_volunteers') }}">ğŸ‘ Volunteers</a>
    <a class="btn soft" href="{{ url_for('admin_feedback') }}">ğŸ“ Feedback</a>
    <a class="btn soft" href="{{ url_for('admin_donations') }}">ğŸ’š Donation Log</a>
  </p>
</div>

<div class="center mt-4">
  <a class="btn soft" href="{{ url_for('logout') }}">â†ª Logout</a>
  <a class="btn soft" href="{{ url_for('home') }}">ğŸ  Home</a>
</div>

<style nonce="{{ csp_nonce() }}">
  .hidden { display:none; }
  .status {
    margin-top:12px; padding:12px; background:#0f1420; color:#e5e7eb;
    border-radius:8px; max-height:320px; overflow:auto; font-size:0.9rem;
  }
  .row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin:8px 0; }
  .row label { font-weight:600; }
</style>

<script nonce="{{ csp_nonce() }}">
(function(){
  const form = document.getElementById('waForm');
  const submit = document.getElementById('waSubmit');
  const status = document.getElementById('status');

  function show(data){
    status.classList.remove('hidden');
    status.textContent = (typeof data === "string") ? data : JSON.stringify(data, null, 2);
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    status.classList.add('hidden');
    submit.disabled = true;
    submit.textContent = 'Sendingâ€¦';

    const fd = new FormData(form);
    const isDryRun = fd.get('dry_run') === 'on';

    // âœ… Open immediately (must be inside click)
    let popup = null;
    if (!isDryRun) {
      popup = window.open('', '_blank'); // <-- no noopener here
    }

    try {
      const res = await fetch('{{ url_for("admin_whatsapp_send") }}', {
        method: 'POST',
        body: fd,
        credentials: 'same-origin'
      });

      const ct = res.headers.get('content-type') || '';
      const data = ct.includes('application/json') ? await res.json() : { ok:true, body: await res.text() };

      show(data);

      if (!isDryRun) {
        // âœ… pick correct URL key
        const mode = (fd.get('mode') || '').toString().toLowerCase();
        let url = null;

        if (mode === 'both') {
          url = data.share_web_morning || data.share_wa_morning || data.share_api_morning;
        } else {
          url = data.share_web || data.share_wa || data.share_api;
        }

        // âœ… If popup blocked or url missing, show it clearly
        if (!url) {
          if (popup) popup.close();
          show({ ok:false, error:"No WhatsApp URL returned", mode, keys: Object.keys(data || {}) });
          return;
        }

        // âœ… Navigate popup
        if (popup) {
          popup.location.href = url;
          popup.focus();
        } else {
          // popup blocked => fallback: open in same tab
          window.location.href = url;
        }
      }

    } catch (err) {
      if (popup) popup.close();
      show({ ok:false, error:String(err) });
    } finally {
      submit.disabled = false;
      submit.textContent = 'Send';
    }
  });
})();
</script>

{% endblock %}
